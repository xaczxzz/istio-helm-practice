apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: default
data:
  01-create-databases.sql: |
    -- Create databases for each service
    SELECT 'CREATE DATABASE order_db' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'order_db')\gexec
    SELECT 'CREATE DATABASE inventory_db' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'inventory_db')\gexec
    SELECT 'CREATE DATABASE user_db' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'user_db')\gexec
    
  02-order-schema.sql: |
    -- Order service schema
    \c order_db;
    
    CREATE TABLE IF NOT EXISTS orders (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL,
        product_id INTEGER NOT NULL,
        quantity INTEGER NOT NULL CHECK (quantity > 0),
        status VARCHAR(50) DEFAULT 'pending',
        total_amount DECIMAL(10,2) DEFAULT 0.00,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE INDEX IF NOT EXISTS idx_orders_user_id ON orders(user_id);
    CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
    CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at);
    
    -- Insert sample orders
    INSERT INTO orders (user_id, product_id, quantity, status, total_amount) VALUES
    (1, 1, 2, 'completed', 1999.98),
    (2, 2, 1, 'pending', 29.99),
    (3, 3, 1, 'completed', 79.99),
    (1, 4, 1, 'shipped', 299.99),
    (4, 5, 2, 'pending', 299.98)
    ON CONFLICT DO NOTHING;
    
  03-inventory-schema.sql: |
    -- Inventory service schema
    \c inventory_db;
    
    CREATE TABLE IF NOT EXISTS inventory (
        id SERIAL PRIMARY KEY,
        product_id INTEGER UNIQUE NOT NULL,
        product_name VARCHAR(255) NOT NULL,
        description TEXT,
        quantity INTEGER NOT NULL DEFAULT 0 CHECK (quantity >= 0),
        price DECIMAL(10,2) NOT NULL DEFAULT 0.00 CHECK (price >= 0),
        category VARCHAR(100),
        supplier VARCHAR(255),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE INDEX IF NOT EXISTS idx_inventory_product_id ON inventory(product_id);
    CREATE INDEX IF NOT EXISTS idx_inventory_category ON inventory(category);
    
    -- Insert sample inventory
    INSERT INTO inventory (product_id, product_name, description, quantity, price, category, supplier) VALUES
    (1, 'Laptop', 'High-performance laptop for professionals', 50, 999.99, 'Electronics', 'TechCorp'),
    (2, 'Wireless Mouse', 'Ergonomic wireless mouse with long battery life', 200, 29.99, 'Accessories', 'TechCorp'),
    (3, 'Mechanical Keyboard', 'RGB mechanical keyboard for gaming and typing', 150, 79.99, 'Accessories', 'GameGear'),
    (4, '4K Monitor', '27-inch 4K monitor with HDR support', 75, 299.99, 'Electronics', 'DisplayTech'),
    (5, 'Noise-Cancelling Headphones', 'Premium headphones with active noise cancellation', 100, 149.99, 'Audio', 'SoundMax')
    ON CONFLICT (product_id) DO NOTHING;
    
  04-user-schema.sql: |
    -- User service schema
    \c user_db;
    
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(100) UNIQUE NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        full_name VARCHAR(255) NOT NULL,
        phone VARCHAR(20),
        address TEXT,
        city VARCHAR(100),
        country VARCHAR(100),
        postal_code VARCHAR(20),
        is_active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
    CREATE INDEX IF NOT EXISTS idx_users_is_active ON users(is_active);
    
    -- Insert sample users
    INSERT INTO users (username, email, full_name, phone, address, city, country, postal_code) VALUES
    ('john_doe', 'john@example.com', 'John Doe', '+1-555-0101', '123 Main St', 'New York', 'USA', '10001'),
    ('jane_smith', 'jane@example.com', 'Jane Smith', '+1-555-0102', '456 Oak Ave', 'Los Angeles', 'USA', '90001'),
    ('bob_wilson', 'bob@example.com', 'Bob Wilson', '+1-555-0103', '789 Pine Rd', 'Chicago', 'USA', '60601'),
    ('alice_brown', 'alice@example.com', 'Alice Brown', '+1-555-0104', '321 Elm St', 'Houston', 'USA', '77001'),
    ('charlie_davis', 'charlie@example.com', 'Charlie Davis', '+1-555-0105', '654 Maple Dr', 'Phoenix', 'USA', '85001')
    ON CONFLICT (username) DO NOTHING;

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
  namespace: default
spec:
  serviceName: postgresql
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
      containers:
      - name: postgresql
        image: postgres:16-alpine
        imagePullPolicy: IfNotPresent
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
          runAsGroup: 999
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        env:
        - name: POSTGRES_DB
          value: postgres
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_PASSWORD
          value: postgres
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        - name: POSTGRES_INITDB_ARGS
          value: "--auth-host=md5 --encoding=UTF8 --locale=C"
        - name: POSTGRES_HOST_AUTH_METHOD
          value: md5
        # PostgreSQL 성능 최적화 설정
        - name: POSTGRES_MAX_CONNECTIONS
          value: "100"
        - name: POSTGRES_SHARED_BUFFERS
          value: "128MB"
        ports:
        - containerPort: 5432
          name: postgresql
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - exec pg_isready -U postgres -h 127.0.0.1 -p 5432
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 6
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - exec pg_isready -U postgres -h 127.0.0.1 -p 5432
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
        volumeMounts:
        - name: init-scripts
          mountPath: /docker-entrypoint-initdb.d
          readOnly: true
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "2000m"
      volumes:
      - name: init-scripts
        configMap:
          name: postgres-init-scripts
  # PersistentVolumeClaim 템플릿 추가 (중요!)
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: 
        - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
      # storageClassName을 지정하거나 기본값 사용
      # storageClassName: standard

---
apiVersion: v1
kind: Service
metadata:
  name: postgresql
  namespace: default
spec:
  selector:
    app: postgresql
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
  type: ClusterIP
  clusterIP: None  # Headless service for StatefulSet